from exploitation_echantillons.echantillon import Echantillon
from exploitation_echantillons.arbre_phylogenetique import arbre
from exploitation_echantillons.calculateur_distances import calculer_distance
from exploitation_echantillons.constants import erreur_fichier, probabilite_mutation, chemin_sequence, fic_err, not_found, incorrect_input

class App:
    """Classe principale de l'application Labo Din'O"""

    @staticmethod
    def verify_probability(probability):
        """Vérifie si la probabilité est bien contenue entre 0 et 100"""
        try:
            prob = float(probability)
            if 0 <= prob <= 100:
                return prob / 100
            else:
                print("\nVeuillez saisir une probabilité entre 0 et 100")
                App.creation_mutation_menu()
        except ValueError:
            print("\nVeuillez entrer un nombre valide")
            App.creation_mutation_menu()

    @staticmethod
    def save_sequence(sequence):
        """Demande à l'utilisateur s'il veut sauvegarder la séquence"""
        save = input("\nVoulez-vous sauvegarder cette séquence ADN ? (o/n) : ")
        save = save.lower()
        if save == "o":
            filepath = input("Entrez le chemin du fichier de sauvegarde : ")
            try:
                Echantillon.sample_writer(filepath, sequence)
                print("Séquence sauvegardée avec succès dans", filepath, "\n")
            except Exception as e:
                print("Erreur lors de la sauvegarde : ", e, "\n")

    @staticmethod
    def creation_mutation_menu():
        print(
            "╔════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║                 Création & Mutation Séquence                   ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║   Veuillez choisir le mode de saisie :                         ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║  A. Saisie manuelle                                            ║"
        )
        print(
            "║  B. Lecture depuis fichier                                     ║"
        )
        print(
            "║  C. Retour                                                     ║"
        )
        print(
            "╚════════════════════════════════════════════════════════════════╝ \n"
        )
        entry = input()
        entry = entry.lower()
        match entry:
            case "a":
                App.manual_mutation_menu()
            case "b":
                App.file_mutation_menu()
            case "c":
                App.start_app()
            case _:
                print(
                    incorrect_input
                )
                App.creation_mutation_menu()

    @staticmethod
    def distance_menu():
        print(
            "╔════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║                    Calcul de Distance                          ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║   Veuillez choisir le mode de saisie :                         ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║  A. Saisie manuelle                                            ║"
        )
        print(
            "║  B. Lecture depuis fichier                                     ║"
        )
        print(
            "║  C. Retour                                                     ║"
        )
        print(
            "╚════════════════════════════════════════════════════════════════╝ \n"
        )
        entry = input()
        entry = entry.lower()
        match entry:
            case "a":
                App.manual_distance_menu()
            case "b":
                App.file_distance_menu()
            case "c":
                App.start_app()
            case _:
                print(
                    incorrect_input
                )
                App.distance_menu()

    @staticmethod
    def species_menu():
        print("╔════════════════════════════════════════════════════════════════╗")
        print("║                    Gestion des Espèces                         ║")
        print("╠════════════════════════════════════════════════════════════════╣")
        print("║                  Arbre Phylogénétique                          ║")
        print("╚════════════════════════════════════════════════════════════════╝\n")
        print(arbre)
        print("\n╔════════════════════════════════════════════════════════════════╗")
        print("║   Veuillez choisir une action :                                ║")
        print("╠════════════════════════════════════════════════════════════════╣")
        print("║  A. Calculer la distance entre deux espèces                    ║")
        print("║  B. Retour                                                     ║")
        print("╚════════════════════════════════════════════════════════════════╝ \n")
        entry = input()
        entry = entry.lower()
        match entry:
            case "a":
                App.calculate_species_distance()
            case "b":
                App.start_app()
            case default:
                print("Veuillez saisir une entrée figurant dans la liste d'actions")
                App.species_menu()

    @staticmethod
    def calculate_species_distance():
        """Calcule la distance entre deux espèces de l'arbre phylogénétique"""
        
        espece1_nom = input("Entrez le nom de la première espèce : ")
        espece2_nom = input("Entrez le nom de la deuxième espèce : ")
        
        try:
            # Chercher les espèces dans l'arbre
            espece1 = App.find_species(arbre, espece1_nom)
            espece2 = App.find_species(arbre, espece2_nom)
            
            if espece1 is None:
                print("\nErreur : L'espèce ", espece1_nom, " n'a pas été trouvée dans l'arbre\n")
                App.species_menu()
                return
            
            if espece2 is None:
                print("\nErreur : L'espèce ", espece2_nom, " n'a pas été trouvée dans l'arbre\n")
                App.species_menu()
                return
            
            # Calculer la distance
            distance = calculer_distance(espece1, espece2)
            
            print("Distance entre ", espece1_nom, " et ", espece2_nom, ": ", distance)
            
        except Exception as e:
            print("Erreur lors du calcul de distance : ", e, "\n")
        
    @staticmethod
    def find_species(specie, name):
        """Recherche récursive d'une espèce par son nom dans l'arbre"""
        if specie.get_nom().lower() == name.lower():
            return specie
        
        for enfant in specie.get_enfants():
            result = App.find_species(enfant, name)
            if result is not None:
                return result
        
        return None

    @staticmethod
    def manual_distance_menu():
        print(
            "╔════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║              Calcul de Distance - Saisie Manuelle              ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║   Veuillez choisir une méthode à utiliser :                    ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║  A. Distance de Levenshtein                                    ║"
        )
        print(
            "║  B. Distance de remplacement de mutation                       ║"
        )
        print(
            "║  C. Retour                                                     ║"
        )
        print(
            "╚════════════════════════════════════════════════════════════════╝ \n"
        )
        entry_seq = input()
        entry_seq = entry_seq.lower()
        match entry_seq:
            case "a":
                sequence1 = input("Entrez la première séquence : ")
                sequence2 = input("Entrez la deuxième séquence : ")
                distance = Echantillon.levenshtein(sequence1, sequence2)
                print("\nDistance de Levenshtein : ", distance, "\n")

            case "b":
                sequence1 = input("Entrez la première séquence : ")
                sequence2 = input("Entrez la deuxième séquence : ")
                distance = Echantillon.mutation_replacement_distance(
                    sequence1, sequence2)
                print("\nDistance de remplacement de mutation : ", distance,
                      "\n")

            case "c":
                App.distance_menu()
            case _:
                print(
                    incorrect_input
                )
                App.manual_distance_menu()

    @staticmethod
    def file_distance_menu():
        print(
            "╔════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║           Calcul de Distance - Lecture de Fichier              ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║   Veuillez choisir une méthode à utiliser :                    ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║  A. Distance de Levenshtein                                    ║"
        )
        print(
            "║  B. Distance de remplacement de mutation                       ║"
        )
        print(
            "║  C. Retour                                                     ║"
        )
        print(
            "╚════════════════════════════════════════════════════════════════╝ \n"
        )
        entry_seq = input()
        entry_seq = entry_seq.lower()
        match entry_seq:
            case "a":
                filepath1 = input("Entrez le chemin du premier fichier : ")
                filepath2 = input("Entrez le chemin du deuxième fichier : ")
                try:
                    sequence1 = Echantillon.sample_reader(filepath1)
                    sequence2 = Echantillon.sample_reader(filepath2)
                    distance = Echantillon.levenshtein(sequence1, sequence2)
                    print("\nDistance de Levenshtein : ", distance, "\n")
                except FileNotFoundError as e:
                    print("Erreur : Fichier non trouvé : ", e)
                    App.file_distance_menu()
                except Exception as e:
                    print(erreur_fichier, e)
                    App.file_distance_menu()

            case "b":
                filepath1 = input("Entrez le chemin du premier fichier : ")
                filepath2 = input("Entrez le chemin du deuxième fichier : ")
                try:
                    sequence1 = Echantillon.sample_reader(filepath1)
                    sequence2 = Echantillon.sample_reader(filepath2)
                    distance = Echantillon.mutation_replacement_distance(
                        sequence1, sequence2)
                    print("\nDistance de remplacement de mutation : ", distance,
                          "\n")
                except FileNotFoundError as e:
                    print("Erreur : Fichier non trouvé : ", e)
                    App.file_distance_menu()
                except Exception as e:
                    print(erreur_fichier, e)
                    App.file_distance_menu()

            case "c":
                App.distance_menu()
            case _:
                print(
                    incorrect_input
                )
                App.file_distance_menu()

    @staticmethod
    def manual_mutation_menu():
        print(
            "╔════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║              Création & Mutation - Saisie Manuelle             ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║   Veuillez choisir une méthode à utiliser :                    ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║  A. Créer une séquence                                         ║"
        )
        print(
            "║  B. Mutation de remplacement                                   ║"
        )
        print(
            "║  C. Mutation de délétion                                       ║"
        )
        print(
            "║  D. Mutation d'insertion                                       ║"
        )
        print(
            "║  E. Mutation                                                   ║"
        )
        print(
            "║  F. Retour                                                     ║"
        )
        print(
            "╚════════════════════════════════════════════════════════════════╝ \n"
        )
        entry_seq = input()
        entry_seq = entry_seq.lower()
        match entry_seq:
            case "a":
                entry = input("Entrez la longueur de la séquence à créer : ")
                try:
                    result = Echantillon.create_sequence(int(entry))
                    App.save_sequence(result)
                except ValueError:
                    print("Veuillez entrer un nombre entier valide")
                    App.manual_mutation_menu()
            case "b":
                sequence = input(
                    "Entrez la séquence à muter par remplacement de base : ")
                probability = input(
                    probabilite_mutation)
                prob = App.verify_probability(probability)
                result = Echantillon.mutation_replacement(sequence, prob)
                App.save_sequence(result)

            case "c":
                sequence = input(
                    "Entrez la séquence à muter par suppression de base : ")
                probability = input(
                    probabilite_mutation)
                prob = App.verify_probability(probability)
                result = Echantillon.mutation_deletion(sequence, prob)
                App.save_sequence(result)

            case "d":
                sequence = input(
                    "Entrez la séquence à muter par ajout de base : ")
                probability = input(
                    probabilite_mutation)
                prob = App.verify_probability(probability)
                result = Echantillon.mutation_insertion(sequence, prob)
                App.save_sequence(result)

            case "e":
                sequence = input("Entrez la séquence à muter : ")
                replacement_probability = input(
                    "Entrez la probabilité de mutation par remplacement en pourcentage : "
                )
                insertion_probability = input(
                    "Entrez la probabilité de mutation par insertion en pourcentage : "
                )
                deletion_probability = input(
                    "Entrez la probabilité de mutation par suppression en pourcentage : "
                )

                prob_rep = App.verify_probability(replacement_probability)
                prob_ins = App.verify_probability(insertion_probability)
                prob_del = App.verify_probability(deletion_probability)

                result = Echantillon.mutation(sequence, prob_rep, prob_ins,
                                              prob_del)
                App.save_sequence(result)

            case "f":
                App.creation_mutation_menu()
            case _:
                print(
                    incorrect_input
                )
                App.manual_mutation_menu()

    @staticmethod
    def file_mutation_menu():
        print(
            "╔════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║           Création & Mutation - Lecture de Fichier             ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║   Veuillez choisir une méthode à utiliser :                    ║"
        )
        print(
            "╠════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║  A. Mutation de remplacement                                   ║"
        )
        print(
            "║  B. Mutation de délétion                                       ║"
        )
        print(
            "║  C. Mutation d'insertion                                       ║"
        )
        print(
            "║  D. Mutation                                                   ║"
        )
        print(
            "║  E. Retour                                                     ║"
        )
        print(
            "╚════════════════════════════════════════════════════════════════╝ \n"
        )
        entry_seq = input()
        entry_seq = entry_seq.lower()
        match entry_seq:
            case "a":
                filepath = input(
                    chemin_sequence)
                probability = input(
                    probabilite_mutation)
                try:
                    sequence = Echantillon.sample_reader(filepath)
                    prob = App.verify_probability(probability)
                    result = Echantillon.mutation_replacement(sequence, prob)
                    App.save_sequence(result)
                except FileNotFoundError:
                    print(fic_err, filepath,
                          not_found)
                    App.file_mutation_menu()
                except Exception as e:
                    print(erreur_fichier, e)
                    App.file_mutation_menu()

            case "b":
                filepath = input(
                    chemin_sequence)
                probability = input(
                    probabilite_mutation)
                try:
                    sequence = Echantillon.sample_reader(filepath)
                    prob = App.verify_probability(probability)
                    result = Echantillon.mutation_deletion(sequence, prob)
                    App.save_sequence(result)
                except FileNotFoundError:
                    print(fic_err, filepath,
                          not_found)
                    App.file_mutation_menu()
                except Exception as e:
                    print(erreur_fichier, e)
                    App.file_mutation_menu()

            case "c":
                filepath = input(
                    chemin_sequence)
                probability = input(
                    probabilite_mutation)
                try:
                    sequence = Echantillon.sample_reader(filepath)
                    prob = App.verify_probability(probability)
                    result = Echantillon.mutation_insertion(sequence, prob)
                    App.save_sequence(result)
                except FileNotFoundError:
                    print(fic_err, filepath,
                          not_found)
                    App.file_mutation_menu()
                except Exception as e:
                    print(erreur_fichier, e)
                    App.file_mutation_menu()

            case "d":
                filepath = input(
                    chemin_sequence)
                replacement_probability = input(
                    "Entrez la probabilité de mutation par remplacement en pourcentage : "
                )
                insertion_probability = input(
                    "Entrez la probabilité de mutation par insertion en pourcentage : "
                )
                deletion_probability = input(
                    "Entrez la probabilité de mutation par suppression en pourcentage : "
                )

                try:
                    sequence = Echantillon.sample_reader(filepath)
                    App.verify_probability(replacement_probability)
                    App.verify_probability(insertion_probability)
                    App.verify_probability(deletion_probability)
                    result = Echantillon.mutation(sequence, replacement_probability, insertion_probability, deletion_probability)

                    App.save_sequence(result)

                except FileNotFoundError:
                    print(fic_err, filepath,
                          not_found)
                    App.file_mutation_menu()
                except Exception as e:
                    print(erreur_fichier, e)
                    App.file_mutation_menu()

            case "e":
                App.creation_mutation_menu()
            case _:
                print(
                    incorrect_input
                )
                App.file_mutation_menu()

    @staticmethod
    def quit():
        print(
            "╔════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║              Merci d'avoir utilisé Labo Din'O !                ║"
        )
        print(
            "╚════════════════════════════════════════════════════════════════╝ \n"
        )

    @staticmethod
    def start_app():
        print(
            "╔═══════════════════════════════════════════════════════════════════════════════════════════════════════╗"
        )
        print(
            "║                       .____          ___.            ________  .__     /\\                             ║"
        )
        print(
            "║                       |    |   _____ \\_ |__   ____   \\______ \\ |__| ___)/  ____                       ║"
        )
        print(
            "║                       |    |   \\__  \\ | __ \\ /  _ \\   |    |  \\|  |/    \\ /  _ \\                      ║"
        )
        print(
            "║                       |    |___ / __ \\| \\_\\ (  <_> )  |    `   \\  |   |  (  <_> )                     ║"
        )
        print(
            "║                       |_______ (____  /___  /\\____/  /_______  /__|___|  /\\____/                      ║"
        )
        print(
            "║                               \\/    \\/    \\/                 \\/        \\/                             ║"
        )
        print(
            "╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║   Veuillez choisir une catégorie à utiliser :                                                         ║"
        )
        print(
            "╠═══════════════════════════════════════════════════════════════════════════════════════════════════════╣"
        )
        print(
            "║  A. Lire une séquence                                                                                 ║"
        )
        print(
            "║  B. Création & Mutation Séquence                                                                      ║"
        )
        print(
            "║  C. Calcul de Distance                                                                                ║"
        )
        print(
            "║  D. Gestion des Espèces                                                                               ║"
        )
        print(
            "║  F. Quitter                                                                                           ║"
        )
        print(
            "╚═══════════════════════════════════════════════════════════════════════════════════════════════════════╝ \n"
        )

        entry = input()
        entry = entry.lower()
        match entry:
            case "a":
                filepath = input("Entrez le chemin du fichier : ")
                try:
                    sequence = Echantillon.sample_reader(filepath)
                    print("\nSéquence lue : ", sequence)
                    print("Longueur : ", len(sequence), "nucléotides\n")
                except FileNotFoundError:
                    print(fic_err, filepath,
                          not_found)
                    App.start_app()
                except Exception as e:
                    print(erreur_fichier, e)
                    App.start_app()

            case "b":
                App.creation_mutation_menu()
            case "c":
                App.distance_menu()
            case "d":
                App.species_menu()
            case "f":
                App.quit()
            case _:
                print(
                    incorrect_input
                )
                App.start_app()


def main():
    App.start_app()


if __name__ == "__main__":
    main()
